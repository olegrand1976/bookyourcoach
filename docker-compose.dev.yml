# =============================================================================
# Docker Compose - BookYourCoach (Développement)
# Configuration pour le développement local
# =============================================================================

version: "3.8"

services:
  # =============================================================================
  # Backend Laravel API (Développement)
  # =============================================================================
  backend-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: activibe-backend-dev
    restart: unless-stopped
    env_file:
      - ./.env.local
    ports:
      - "8080:80"
      - "8001:8000"
    volumes:
      - ./app:/var/www/html/app
      - ./config:/var/www/html/config
      - ./routes:/var/www/html/routes
      - ./database:/var/www/html/database
      - ./tests:/var/www/html/tests
      - app_storage_dev:/var/www/storage
      - app_bootstrap_cache_dev:/var/www/bootstrap/cache
    depends_on:
      - neo4j-dev
      - mysql-dev
    networks:
      - app-network-dev
    environment:
      - APP_ENV=local
      - APP_DEBUG=true

  # =============================================================================
  # Frontend Nuxt.js (Développement)
  # =============================================================================
  frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: test
    container_name: activibe-frontend-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.nuxt
    environment:
      - NODE_ENV=development
      - NUXT_HOST=0.0.0.0
      - NUXT_PORT=3000
      - NUXT_PUBLIC_API_BASE=http://localhost:8080/api
      - NUXT_API_BASE=http://localhost:8080/api
    networks:
      - app-network-dev
    command: npm run dev

  # =============================================================================
  # Neo4j pour développement
  # =============================================================================
  neo4j-dev:
    image: neo4j:5.15-community
    container_name: activibe-neo4j-dev
    restart: unless-stopped
    ports:
      - "7475:7474"  # Interface web (port différent pour éviter les conflits)
      - "7688:7687"  # Bolt protocol (port différent)
    environment:
      - NEO4J_AUTH=neo4j/development
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    volumes:
      - neo4j_data_dev:/data
      - neo4j_logs_dev:/logs
    networks:
      - app-network-dev

  # =============================================================================
  # MySQL local pour développement
  # =============================================================================
  mysql-dev:
    image: mysql:8.0
    container_name: activibe-mysql-dev
    restart: unless-stopped
    ports:
      - "3309:3306"  # Port différent pour éviter les conflits
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=book_your_coach_dev
      - MYSQL_USER=activibe_user
      - MYSQL_PASSWORD=activibe_password
    volumes:
      - mysql_local_data_dev:/var/lib/mysql
    networks:
      - app-network-dev
    command: --default-authentication-plugin=mysql_native_password

# =============================================================================
# Volumes pour le développement
# =============================================================================
volumes:
  neo4j_data_dev:
    driver: local
  neo4j_logs_dev:
    driver: local
  mysql_local_data_dev:
    driver: local
  app_storage_dev:
    driver: local
  app_bootstrap_cache_dev:
    driver: local

# =============================================================================
# Réseau pour le développement
# =============================================================================
networks:
  app-network-dev:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
