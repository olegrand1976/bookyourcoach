name: ðŸ§ª Tests Serveur

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type de tests Ã  exÃ©cuter'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - connectivity
        - api
        - containers
      verbose:
        description: 'Mode verbeux (plus de dÃ©tails)'
        required: false
        default: 'false'
        type: boolean

env:
  COMPOSE_FILE: docker-compose.yml

jobs:
  test-connectivity:
    name: ðŸ”Œ Tests de ConnectivitÃ©
    runs-on: ubuntu-latest
    if: inputs.test_type == 'all' || inputs.test_type == 'connectivity'
    
    steps:
    - name: ðŸ”‘ Configuration SSH
      run: |
        echo "ðŸ”§ Configuration de la connexion SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        cat > ~/.ssh/config << EOF
        Host production-server
          HostName ${{ vars.SERVER_HOST }}
          User ${{ vars.SERVER_USERNAME }}
          Port ${{ vars.SERVER_PORT }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config

    - name: ðŸ”Œ Tests de connectivitÃ©
      run: |
        echo "ðŸ” Tests de connectivitÃ© des services..."
        
        # Test frontend (port 3000)
        echo "ðŸ”Œ Test du Frontend (port 3000)..."
        if ssh production-server "curl -f http://localhost:3000" >/dev/null 2>&1; then
          echo "âœ… Frontend (port 3000) : Accessible"
        else
          echo "âŒ Frontend (port 3000) : Non accessible"
          exit 1
        fi
        
        # Test API backend (port 8080)
        echo "ðŸ”Œ Test du Backend API (port 8080)..."
        if ssh production-server "curl -f http://localhost:8080" >/dev/null 2>&1; then
          echo "âœ… Backend API (port 8080) : Accessible"
        else
          echo "âŒ Backend API (port 8080) : Non accessible"
          exit 1
        fi
        
        # Test Neo4j (port 7474)
        echo "ðŸ”Œ Test de Neo4j (port 7474)..."
        if ssh production-server "curl -f -H 'Accept: application/json' http://localhost:7474" >/dev/null 2>&1; then
          echo "âœ… Neo4j (port 7474) : Accessible"
        else
          echo "âŒ Neo4j (port 7474) : Non accessible"
          exit 1
        fi
        
        # Test phpMyAdmin (port 8082)
        echo "ðŸ”Œ Test de phpMyAdmin (port 8082)..."
        if ssh production-server "curl -f http://localhost:8082" >/dev/null 2>&1; then
          echo "âœ… phpMyAdmin (port 8082) : Accessible"
        else
          echo "âŒ phpMyAdmin (port 8082) : Non accessible"
          exit 1
        fi
        
        # Test de l'IP privÃ©e
        echo "ðŸ”Œ Test de l'IP privÃ©e 10.0.0.244..."
        if ssh production-server "curl -f http://10.0.0.244:3000" >/dev/null 2>&1; then
          echo "âœ… Frontend sur 10.0.0.244:3000 : Accessible"
        else
          echo "âŒ Frontend sur 10.0.0.244:3000 : Non accessible"
          exit 1
        fi
        
        if ssh production-server "curl -f http://10.0.0.244:8080" >/dev/null 2>&1; then
          echo "âœ… API sur 10.0.0.244:8080 : Accessible"
        else
          echo "âŒ API sur 10.0.0.244:8080 : Non accessible"
          exit 1
        fi
        
        echo "âœ… Tous les tests de connectivitÃ© ont rÃ©ussi !"

  test-api:
    name: ðŸ§ª Tests API
    runs-on: ubuntu-latest
    if: inputs.test_type == 'all' || inputs.test_type == 'api'
    
    steps:
    - name: ðŸ”‘ Configuration SSH
      run: |
        echo "ðŸ”§ Configuration de la connexion SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        cat > ~/.ssh/config << EOF
        Host production-server
          HostName ${{ vars.SERVER_HOST }}
          User ${{ vars.SERVER_USERNAME }}
          Port ${{ vars.SERVER_PORT }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config

    - name: ðŸ§ª Tests API Laravel
      run: |
        echo "ðŸ§ª Tests de l'API Laravel..."
        
        # Test de l'endpoint de login
        echo "ðŸ” Test de l'endpoint de login..."
        if ssh production-server 'curl -s -X POST http://localhost:8080/api/auth/login -H "Content-Type: application/json" -d "{\"email\":\"test@test.com\",\"password\":\"test\"}" | grep -q "Invalid credentials"'; then
          echo "âœ… Endpoint de login : Fonctionnel"
        else
          echo "âŒ Endpoint de login : Non fonctionnel"
          exit 1
        fi
        
        # Test de l'endpoint d'activitÃ©s
        echo "ðŸƒ Test de l'endpoint d'activitÃ©s..."
        if ssh production-server 'curl -s -X GET http://localhost:8080/api/activity-types | grep -q "success"'; then
          echo "âœ… Endpoint d'activitÃ©s : Fonctionnel"
        else
          echo "âŒ Endpoint d'activitÃ©s : Non fonctionnel"
          exit 1
        fi
        
        # Test de l'endpoint de santÃ©
        echo "ðŸ’š Test de l'endpoint de santÃ©..."
        if ssh production-server 'curl -s -X GET http://localhost:8080/api/health 2>/dev/null || curl -s -X GET http://localhost:8080/ | grep -q "Laravel"'; then
          echo "âœ… Endpoint de santÃ© : Fonctionnel"
        else
          echo "âŒ Endpoint de santÃ© : Non fonctionnel"
          exit 1
        fi
        
        echo "âœ… Tous les tests API ont rÃ©ussi !"

  test-containers:
    name: ðŸ³ Tests des Conteneurs
    runs-on: ubuntu-latest
    if: inputs.test_type == 'all' || inputs.test_type == 'containers'
    
    steps:
    - name: ðŸ”‘ Configuration SSH
      run: |
        echo "ðŸ”§ Configuration de la connexion SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        cat > ~/.ssh/config << EOF
        Host production-server
          HostName ${{ vars.SERVER_HOST }}
          User ${{ vars.SERVER_USERNAME }}
          Port ${{ vars.SERVER_PORT }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config

    - name: ðŸ³ Tests des conteneurs
      run: |
        echo "ðŸ³ Tests des conteneurs Docker..."
        
        # VÃ©rification de l'Ã©tat des conteneurs
        echo "ðŸ“Š Ã‰tat des conteneurs :"
        ssh production-server "cd /srv/activibe && docker compose -f docker-compose.yml ps"
        
        # VÃ©rification des conteneurs en cours d'exÃ©cution
        echo "ðŸ”„ VÃ©rification des conteneurs en cours d'exÃ©cution..."
        for container in activibe-backend activibe-frontend activibe-phpmyadmin activibe-neo4j; do
          if ssh production-server "docker ps --format '{{.Names}}' | grep -q '^$container$'"; then
            echo "âœ… $container : En cours d'exÃ©cution"
          else
            echo "âŒ $container : Non en cours d'exÃ©cution"
            exit 1
          fi
        done
        
        # VÃ©rification des volumes
        echo "ðŸ’¾ VÃ©rification des volumes Docker..."
        ssh production-server "docker volume ls | grep activibe"
        
        # VÃ©rification des rÃ©seaux
        echo "ðŸŒ VÃ©rification des rÃ©seaux Docker..."
        ssh production-server "docker network ls | grep activibe"
        
        # Test des logs (derniÃ¨res 10 lignes)
        if [[ "${{ inputs.verbose }}" == "true" ]]; then
          echo "ðŸ“‹ Logs rÃ©cents des conteneurs..."
          echo "=== Logs Backend ==="
          ssh production-server "cd /srv/activibe && docker logs --tail=10 activibe-backend"
          echo "=== Logs Frontend ==="
          ssh production-server "cd /srv/activibe && docker logs --tail=10 activibe-frontend"
          echo "=== Logs Neo4j ==="
          ssh production-server "cd /srv/activibe && docker logs --tail=10 activibe-neo4j"
        fi
        
        echo "âœ… Tous les tests des conteneurs ont rÃ©ussi !"

  summary:
    name: ðŸ“Š RÃ©sumÃ© des Tests
    runs-on: ubuntu-latest
    needs: [test-connectivity, test-api, test-containers]
    if: always()
    
    steps:
    - name: ðŸ“Š RÃ©sumÃ© final
      run: |
        echo "ðŸ§ª RÃ‰SUMÃ‰ DES TESTS"
        echo "=================="
        echo ""
        
        if [[ "${{ needs.test-connectivity.result }}" == "success" ]]; then
          echo "âœ… Tests de connectivitÃ© : SUCCÃˆS"
        else
          echo "âŒ Tests de connectivitÃ© : Ã‰CHEC"
        fi
        
        if [[ "${{ needs.test-api.result }}" == "success" ]]; then
          echo "âœ… Tests API : SUCCÃˆS"
        else
          echo "âŒ Tests API : Ã‰CHEC"
        fi
        
        if [[ "${{ needs.test-containers.result }}" == "success" ]]; then
          echo "âœ… Tests des conteneurs : SUCCÃˆS"
        else
          echo "âŒ Tests des conteneurs : Ã‰CHEC"
        fi
        
        echo ""
        echo "ðŸ“… Date : $(date)"
        echo "ðŸ”§ Type de tests : ${{ inputs.test_type }}"
        echo "ðŸ“ Mode verbeux : ${{ inputs.verbose }}"
        
        # DÃ©terminer le rÃ©sultat global
        if [[ "${{ needs.test-connectivity.result }}" == "success" && "${{ needs.test-api.result }}" == "success" && "${{ needs.test-containers.result }}" == "success" ]]; then
          echo ""
          echo "ðŸŽ‰ TOUS LES TESTS ONT RÃ‰USSI !"
          exit 0
        else
          echo ""
          echo "âŒ CERTAINS TESTS ONT Ã‰CHOUÃ‰ !"
          exit 1
        fi
