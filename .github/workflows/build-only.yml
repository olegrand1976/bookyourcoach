name: ğŸ—ï¸ Build Images Docker

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Forcer la reconstruction complÃ¨te (sans cache)'
        required: false
        default: 'false'
        type: boolean
      build_backend:
        description: 'Builder le backend Laravel'
        required: false
        default: 'true'
        type: boolean
      build_frontend:
        description: 'Builder le frontend Nuxt.js'
        required: false
        default: 'true'
        type: boolean

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: ${{ vars.DOCKERHUB_USERNAME }}/activibe-app
  FRONTEND_IMAGE_NAME: ${{ vars.DOCKERHUB_USERNAME }}/activibe-frontend

jobs:
  build-backend:
    name: ğŸ—ï¸ Build Backend Laravel
    runs-on: ubuntu-latest
    if: inputs.build_backend == 'true'
    outputs:
      image: ${{ steps.build.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Configuration Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Connexion DockerHub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    
    - name: ğŸ—ï¸ Build Backend
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:latest
          ${{ env.IMAGE_NAME }}:build-$(date +%Y%m%d-%H%M%S)
        cache-from: ${{ inputs.force_rebuild == 'false' && 'type=gha,scope=backend' || '' }}
        cache-to: ${{ inputs.force_rebuild == 'false' && 'type=gha,mode=max,scope=backend' || '' }}
        no-cache: ${{ inputs.force_rebuild == 'true' }}

    - name: ğŸ“‹ RÃ©sumÃ© Backend
      run: |
        echo "âœ… Backend Laravel construit avec succÃ¨s !"
        echo "ğŸ—ï¸ Image: ${{ env.IMAGE_NAME }}:latest"
        echo "ğŸ“¦ Digest: ${{ steps.build.outputs.digest }}"

  build-frontend:
    name: ğŸ¨ Build Frontend Nuxt.js
    runs-on: ubuntu-latest
    if: inputs.build_frontend == 'true'
    outputs:
      image: ${{ steps.build.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Configuration Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Connexion DockerHub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    
    - name: ğŸ¨ Build Frontend
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.FRONTEND_IMAGE_NAME }}:latest
          ${{ env.FRONTEND_IMAGE_NAME }}:build-$(date +%Y%m%d-%H%M%S)
        cache-from: ${{ inputs.force_rebuild == 'false' && 'type=gha,scope=frontend' || '' }}
        cache-to: ${{ inputs.force_rebuild == 'false' && 'type=gha,mode=max,scope=frontend' || '' }}
        no-cache: ${{ inputs.force_rebuild == 'true' }}

    - name: ğŸ“‹ RÃ©sumÃ© Frontend
      run: |
        echo "âœ… Frontend Nuxt.js construit avec succÃ¨s !"
        echo "ğŸ¨ Image: ${{ env.FRONTEND_IMAGE_NAME }}:latest"
        echo "ğŸ“¦ Digest: ${{ steps.build.outputs.digest }}"

  summary:
    name: ğŸ“Š RÃ©sumÃ© du Build
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always()
    
    steps:
    - name: ğŸ“Š RÃ©sumÃ© final
      run: |
        echo "ğŸ—ï¸ RÃ‰SUMÃ‰ DU BUILD"
        echo "=================="
        echo ""
        
        if [[ "${{ needs.build-backend.result }}" == "success" ]]; then
          echo "âœ… Backend Laravel : SUCCÃˆS"
          echo "   Image: ${{ env.IMAGE_NAME }}:latest"
        else
          echo "âŒ Backend Laravel : Ã‰CHEC"
        fi
        
        if [[ "${{ needs.build-frontend.result }}" == "success" ]]; then
          echo "âœ… Frontend Nuxt.js : SUCCÃˆS"
          echo "   Image: ${{ env.FRONTEND_IMAGE_NAME }}:latest"
        else
          echo "âŒ Frontend Nuxt.js : Ã‰CHEC"
        fi
        
        echo ""
        echo "ğŸ“… Date : $(date)"
        echo "ğŸ”„ Force rebuild : ${{ inputs.force_rebuild }}"
