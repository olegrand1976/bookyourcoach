name: ğŸš€ DÃ©ploiement Production Automatique

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Forcer la reconstruction des images'
        required: false
        default: 'false'
        type: boolean

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: ${{ vars.DOCKERHUB_USERNAME }}/activibe-app
  COMPOSE_FILE: docker-compose.yml # Changement de nom
  ENV_FILE: production.env

jobs:
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Configuration Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Connexion DockerHub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    
    - name: ğŸ—ï¸ Build et Push de l'image Docker
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:latest
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ğŸ“ GÃ©nÃ©ration des fichiers de configuration
      run: |
        echo "ğŸ”§ CrÃ©ation du fichier docker-compose.yml (version simplifiÃ©e)..."
        cat > docker-compose.yml << 'EOF'
        version: "3.8"

        services:
          # Application Laravel + Nuxt (image unique)
          app:
            image: ${IMAGE_NAME:-${{ env.IMAGE_NAME }}:latest}
            container_name: activibe-app
            restart: unless-stopped
            env_file:
              - ./.env
            ports:
              # Exposition directe : port 8080 du serveur -> port 80 du conteneur (Laravel via Nginx)
              - "8080:80"
            volumes:
              - app_storage:/var/www/storage
              - app_bootstrap_cache:/var/www/bootstrap/cache
              - /srv/activibe/cert.pem:/var/www/html/cert.pem:ro
            depends_on:
              - redis
              - neo4j
            networks:
              - app-network

          # phpMyAdmin pour administrer la base de donnÃ©es OVH
          phpmyadmin:
            image: phpmyadmin:latest
            container_name: activibe-phpmyadmin
            restart: unless-stopped
            ports:
              # Exposition sur le port 8082 pour Ã©viter les conflits
              - "8082:80"
            environment:
              - PMA_HOST=${DB_HOST}
              - PMA_PORT=${DB_PORT}
              - PMA_USER=${DB_USERNAME}
              - PMA_PASSWORD=${DB_PASSWORD}
              - UPLOAD_LIMIT=256M
              - MEMORY_LIMIT=512M
            networks:
              - app-network

          # Redis pour cache et sessions
          redis:
            image: redis:7-alpine
            container_name: activibe-redis
            restart: unless-stopped
            volumes:
              - redis_data:/data
            networks:
              - app-network
            command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}

          # Neo4j pour analyses graphiques
          neo4j:
            image: neo4j:5.15-community
            container_name: activibe-neo4j
            restart: unless-stopped
            ports:
              - "7474:7474"  # Interface web
              - "7687:7687"  # Bolt protocol
            environment:
              - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
              - NEO4J_PLUGINS=["apoc"]
              - NEO4J_dbms_security_procedures_unrestricted=apoc.*
              - NEO4J_dbms_security_procedures_allowlist=apoc.*
            volumes:
              - neo4j_data:/data
              - neo4j_logs:/logs
              - neo4j_import:/var/lib/neo4j/import
              - neo4j_plugins:/plugins
            networks:
              - app-network

        volumes:
          redis_data:
            driver: local
          neo4j_data:
            driver: local
          neo4j_logs:
            driver: local
          neo4j_import:
            driver: local
          neo4j_plugins:
            driver: local
          app_storage:
            driver: local
          app_bootstrap_cache:
            driver: local

        networks:
          app-network:
            driver: bridge
        EOF

        echo "ğŸ”§ GÃ©nÃ©ration de APP_KEY Laravel..."
        APP_KEY=$(openssl rand -base64 32)
        
        echo "ğŸ”§ CrÃ©ation du script de mise Ã  jour .env..."
        cat > update-env.sh << 'EOF'
        #!/bin/bash
        # Script pour vÃ©rifier/gÃ©nÃ©rer APP_KEY dans le fichier .env existant
        
        if [[ -f ".env" ]]; then
            # VÃ©rifier si APP_KEY existe et est valide
            current_key=$(grep "^APP_KEY=" .env | cut -d'=' -f2)
            
            if [[ -n "$current_key" && "$current_key" != "base64:\$(openssl rand -base64 32)" && "$current_key" =~ ^base64:[A-Za-z0-9+/]{43}=?$ ]]; then
                echo "âœ… APP_KEY valide trouvÃ©e - conservation de la clÃ© existante"
                echo "ğŸ”‘ APP_KEY actuelle: ${current_key:0:15}..."
            else
                echo "ğŸ“ APP_KEY manquante ou invalide - gÃ©nÃ©ration d'une nouvelle clÃ©..."
                if grep -q "^APP_KEY=" .env; then
                    sed -i "s/^APP_KEY=.*/APP_KEY=base64:$1/" .env
                else
                    echo "APP_KEY=base64:$1" >> .env
                fi
                echo "âœ… Nouvelle APP_KEY gÃ©nÃ©rÃ©e avec succÃ¨s"
                echo "ğŸ”‘ Nouvelle APP_KEY: base64:${1:0:10}..."
            fi
        else
            echo "âŒ Fichier .env non trouvÃ©"
            exit 1
        fi
        EOF
        
        chmod +x update-env.sh

        echo "ğŸ”§ CrÃ©ation du script de dÃ©ploiement automatique (version simplifiÃ©e)..."
        cat > auto-deploy.sh << 'EOF'
        #!/bin/bash
        # Script de dÃ©ploiement automatique via GitHub Actions (simplifiÃ©)

        set -e

        # Couleurs
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m'

        log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
        log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
        log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
        log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }

        # Configuration
        COMPOSE_FILE="docker-compose.yml"
        ENV_FILE=".env"
        APP_DIR="/srv/activibe"

        log_step "ğŸš€ DÃ©marrage du dÃ©ploiement automatique (simplifiÃ©)..."

        # ArrÃªt propre des containers existants
        log_info "ğŸ›‘ ArrÃªt des containers existants..."
        
        # Essayer d'arrÃªter avec docker compose si possible
        if [[ -f "$COMPOSE_FILE" ]]; then
            docker compose -f "$COMPOSE_FILE" down --remove-orphans 2>/dev/null || true
        fi
        
        # ArrÃªt forcÃ© des containers connus au cas oÃ¹
        for container in activibe-app activibe-phpmyadmin activibe-redis activibe-neo4j; do
            if docker ps --format '{{.Names}}' | grep -q "^$container$"; then
                log_info "ğŸ”„ ArrÃªt de $container..."
                docker stop "$container" 2>/dev/null || true
                docker rm "$container" 2>/dev/null || true
            fi
        done

        # Nettoyage des ressources orphelines
        log_info "ğŸ§¹ Nettoyage des ressources orphelines..."
        docker container prune -f 2>/dev/null || true
        docker network prune -f 2>/dev/null || true

        # Mise Ã  jour de APP_KEY dans .env
        log_info "ğŸ”‘ Mise Ã  jour de APP_KEY..."
        if [[ -f "update-env.sh" && -f ".env" ]]; then
            ./update-env.sh "$1"
        else
            log_warning "âš ï¸  Impossible de mettre Ã  jour APP_KEY - fichiers manquants"
        fi

        # Pull de la derniÃ¨re image
        log_info "ğŸ“¥ RÃ©cupÃ©ration de la derniÃ¨re image Docker..."
        source ".env"
        docker pull "${IMAGE_NAME}:latest" || {
            log_warning "âš ï¸  Impossible de rÃ©cupÃ©rer l'image, utilisation de l'image locale"
        }

        # DÃ©marrage des services
        log_info "ğŸš€ DÃ©marrage des services..."
        docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" up -d

        # Attente du dÃ©marrage
        log_info "â³ Attente du dÃ©marrage des services (30 secondes)..."
        sleep 30

        # VÃ©rification de l'Ã©tat des services
        log_step "ğŸ” VÃ©rification de l'Ã©tat des services..."
        docker compose -f "$COMPOSE_FILE" ps

        # Tests de connectivitÃ©
        log_step "ğŸ§ª Tests de connectivitÃ©..."

        # Test de l'application (port 8080)
        log_info "ğŸ”Œ Test du port 8080 (Application)..."
        if curl -f http://localhost:8080 >/dev/null 2>&1; then
            log_info "âœ… Port 8080 (Application) : Accessible"
        else
            log_warning "âš ï¸  Port 8080 (Application) : Non accessible (peut nÃ©cessiter plus de temps)"
        fi

        # Test port 7474 (Neo4j)
        log_info "ğŸ”Œ Test du port 7474 (Neo4j)..."
        if curl -f http://localhost:7474 >/dev/null 2>&1; then
            log_info "âœ… Port 7474 (Neo4j) : Accessible"
        else
            log_warning "âš ï¸  Port 7474 (Neo4j) : Non accessible"
        fi

        # Logs rÃ©cents
        log_step "ğŸ“‹ Logs rÃ©cents du conteneur applicatif..."
        
        echo "=== Logs activibe-app ==="
        docker logs --tail=20 activibe-app 2>/dev/null || log_warning "Pas de logs pour activibe-app"

        # RÃ©sumÃ© final
        log_step "ğŸ“Š RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT"
        log_info "ğŸ¯ URLs d'accÃ¨s :"
        log_info "   â€¢ Application principale : http://$(curl -s ifconfig.me):8080"
        log_info "   â€¢ phpMyAdmin : http://$(curl -s ifconfig.me):8082"
        log_info "   â€¢ Neo4j Interface : http://$(curl -s ifconfig.me):7474"
        log_info "   â€¢ Infiswap Front (prÃ©servÃ©) : http://$(curl -s ifconfig.me):80"
        
        log_step "âœ… DÃ©ploiement automatique terminÃ© !"
        EOF

        chmod +x auto-deploy.sh

        echo "âœ… Fichiers de configuration gÃ©nÃ©rÃ©s avec succÃ¨s !"

    - name: ğŸ”‘ Configuration SSH
      run: |
        echo "ğŸ”§ Configuration de la connexion SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Configuration SSH pour Ã©viter les vÃ©rifications d'hÃ´te
        cat > ~/.ssh/config << EOF
        Host production-server
          HostName ${{ vars.SERVER_HOST }}
          User ${{ vars.SERVER_USERNAME }}
          Port ${{ vars.SERVER_PORT }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config

    - name: ğŸ“¤ DÃ©ploiement sur le serveur
      run: |
        echo "ğŸš€ DÃ©ploiement des fichiers sur le serveur..."
        
        # CrÃ©ation du rÃ©pertoire de dÃ©ploiement
        ssh production-server "mkdir -p /srv/activibe && cd /srv/activibe"
        
        # Copie des fichiers de configuration
        echo "ğŸ“ Copie des fichiers de configuration..."
        scp docker-compose.yml production-server:/srv/activibe/
        scp update-env.sh production-server:/srv/activibe/
        scp auto-deploy.sh production-server:/srv/activibe/
        
        # ExÃ©cution du script de dÃ©ploiement
        echo "ğŸ¯ ExÃ©cution du dÃ©ploiement automatique..."
        ssh production-server "cd /srv/activibe && chmod +x auto-deploy.sh && chmod +x update-env.sh && ./auto-deploy.sh $APP_KEY"

    - name: ğŸ§ª Tests post-dÃ©ploiement
      run: |
        echo "ğŸ” Tests de vÃ©rification post-dÃ©ploiement..."
        
        # Test de connectivitÃ© des services
        echo "ğŸŒ Test des services sur le serveur..."
        
        # Test application (port 8080)
        if ssh production-server "curl -f http://localhost:8080" >/dev/null 2>&1; then
          echo "âœ… Application (port 8080) : OK"
        else
          echo "âš ï¸  Application (port 8080) : KO (peut nÃ©cessiter plus de temps)"
        fi
        
        # Test Neo4j (port 7474)
        if ssh production-server "curl -f http://localhost:7474" >/dev/null 2>&1; then
          echo "âœ… Neo4j (port 7474) : OK"
        else
          echo "âš ï¸  Neo4j (port 7474) : KO"
        fi
        
        # Affichage de l'Ã©tat des containers
        echo "ğŸ“Š Ã‰tat des containers :"
        ssh production-server "cd /srv/activibe && docker compose -f docker-compose.yml ps"

    - name: ğŸ“§ Notification de succÃ¨s
      if: success()
      run: |
        echo "ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI !"
        echo ""
        echo "ğŸŒ L'application BookYourCoach est maintenant accessible :"
        echo "   â€¢ Application : http://${{ vars.SERVER_HOST }}:8080"
        echo "   â€¢ phpMyAdmin : http://${{ vars.SERVER_HOST }}:8082"
        echo "   â€¢ Infiswap Front (prÃ©servÃ©) : http://${{ vars.SERVER_HOST }}:80"
        echo "   â€¢ Neo4j : http://${{ vars.SERVER_HOST }}:7474"
        echo ""
        echo "ğŸ³ Image dÃ©ployÃ©e : ${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "ğŸ“… Date : $(date)"

    - name: ğŸš¨ Notification d'Ã©chec
      if: failure()
      run: |
        echo "âŒ Ã‰CHEC DU DÃ‰PLOIEMENT !"
        echo ""
        echo "ğŸ” VÃ©rifiez les logs ci-dessus pour identifier le problÃ¨me."
        echo "ğŸ“‹ Points Ã  vÃ©rifier :"
        echo "   â€¢ Connexion SSH au serveur"
        echo "   â€¢ Variables d'environnement GitHub"
        echo "   â€¢ DisponibilitÃ© de DockerHub"
        echo "   â€¢ Ã‰tat du serveur de production"
        echo ""
        echo "ğŸ†˜ En cas de problÃ¨me persistant, connectez-vous manuellement :"
        echo "   ssh ${{ vars.SERVER_USERNAME }}@${{ vars.SERVER_HOST }}"
        echo "   cd /srv/activibe && ./auto-deploy.sh"
