name: 🚀 Déploiement Production Automatique

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Forcer la reconstruction des images'
        required: false
        default: 'false'
        type: boolean

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: ${{ vars.DOCKERHUB_USERNAME }}/activibe-app
  FRONTEND_IMAGE_NAME: ${{ vars.DOCKERHUB_USERNAME }}/activibe-frontend
  COMPOSE_FILE: docker-compose.yml
  ENV_FILE: production.env

jobs:
  build-and-deploy:
    name: 🏗️ Build & Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout du code
      uses: actions/checkout@v4
      
    - name: 🐳 Configuration Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: 🔐 Connexion DockerHub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    
    - name: 🏗️ Build et Push de l'image Backend (Laravel)
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:latest
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: 🎨 Build et Push de l'image Frontend (Nuxt.js)
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.FRONTEND_IMAGE_NAME }}:latest
          ${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: 📝 Génération des fichiers de configuration
      run: |
        echo "🔧 Création du fichier docker-compose.yml (version simplifiée)..."
        echo "⚠️  ATTENTION: La configuration serveur est maintenant stable - pas de modification des fichiers"
        cat > docker-compose.yml << 'EOF'
        version: "3.8"

        services:
          # Backend Laravel API
          backend:
            image: ${IMAGE_NAME:-${{ env.IMAGE_NAME }}:latest}
            container_name: activibe-backend
            restart: unless-stopped
            env_file:
              - ./.env
            ports:
              # API Backend accessible en interne et externe
              - "8080:80"
            volumes:
              - app_storage:/var/www/storage
              - app_bootstrap_cache:/var/www/bootstrap/cache
              - /srv/activibe/cert.pem:/var/www/html/cert.pem:ro
              - /srv/activibe/.env:/var/www/html/.env:ro
            depends_on:
              - neo4j
            networks:
              - app-network

          # Frontend Nuxt.js
          frontend:
            image: ${FRONTEND_IMAGE_NAME:-${{ vars.DOCKERHUB_USERNAME }}/activibe-frontend:latest}
            container_name: activibe-frontend
            restart: unless-stopped
            ports:
              # Frontend accessible sur le port 3000
              - "3000:3000"
            environment:
              # Configuration pour le navigateur (utilise le reverse proxy externe pour éviter Mixed Block)
              - NUXT_PUBLIC_API_BASE=https://activibe.be/api
              # Configuration côté serveur pour Docker (communication interne)
              - NUXT_API_BASE=http://activibe-backend:80/api
              - NITRO_HOST=0.0.0.0
              - NITRO_PORT=3000
            depends_on:
              - backend
            networks:
              - app-network

          # phpMyAdmin pour administrer la base de données OVH
          phpmyadmin:
            image: phpmyadmin:latest
            container_name: activibe-phpmyadmin
            restart: unless-stopped
            ports:
              # Exposition sur le port 8082 pour éviter les conflits
              - "8082:80"
            environment:
              - PMA_HOST=${DB_HOST}
              - PMA_PORT=${DB_PORT}
              - PMA_USER=${DB_USERNAME}
              - PMA_PASSWORD=${DB_PASSWORD}
              - UPLOAD_LIMIT=256M
              - MEMORY_LIMIT=512M
            networks:
              - app-network

          # Redis hébergé sur OVH (pas de conteneur local nécessaire)

          # Neo4j pour analyses graphiques
          neo4j:
            image: neo4j:5.15-community
            container_name: activibe-neo4j
            restart: unless-stopped
            ports:
              - "7474:7474"  # Interface web
              - "7687:7687"  # Bolt protocol
            environment:
              - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
              - NEO4J_PLUGINS=["apoc"]
              - NEO4J_dbms_security_procedures_unrestricted=apoc.*
              - NEO4J_dbms_security_procedures_allowlist=apoc.*
            volumes:
              - neo4j_data:/data
              - neo4j_logs:/logs
              - neo4j_import:/var/lib/neo4j/import
              - neo4j_plugins:/plugins
            networks:
              - app-network

        volumes:
          neo4j_data:
            driver: local
          neo4j_logs:
            driver: local
          neo4j_import:
            driver: local
          neo4j_plugins:
            driver: local
          app_storage:
            driver: local
          app_bootstrap_cache:
            driver: local

        networks:
          app-network:
            driver: bridge
        EOF

        echo "🔧 Génération de APP_KEY Laravel..."
        APP_KEY=$(openssl rand -base64 32)
        
        echo "🔧 Création du script de mise à jour .env..."
        cat > update-env.sh << 'EOF'
        #!/bin/bash
        # Script pour vérifier/générer APP_KEY dans le fichier .env existant
        
        if [[ -f ".env" ]]; then
            # Vérifier si APP_KEY existe et est valide
            current_key=$(grep "^APP_KEY=" .env | cut -d'=' -f2)
            
            if [[ -n "$current_key" && "$current_key" != "base64:\$(openssl rand -base64 32)" && "$current_key" =~ ^base64:[A-Za-z0-9+/]{43}=?$ ]]; then
                echo "✅ APP_KEY valide trouvée - conservation de la clé existante"
                echo "🔑 APP_KEY actuelle: ${current_key:0:15}..."
            else
                echo "📝 APP_KEY manquante ou invalide - génération d'une nouvelle clé..."
                if grep -q "^APP_KEY=" .env; then
                    sed -i "s/^APP_KEY=.*/APP_KEY=base64:$1/" .env
                else
                    echo "APP_KEY=base64:$1" >> .env
                fi
                echo "✅ Nouvelle APP_KEY générée avec succès"
                echo "🔑 Nouvelle APP_KEY: base64:${1:0:10}..."
            fi
        else
            echo "❌ Fichier .env non trouvé"
            exit 1
        fi
        EOF
        
        chmod +x update-env.sh

        echo "🔧 Création du script de déploiement automatique (version simplifiée)..."
        cat > auto-deploy.sh << 'EOF'
        #!/bin/bash
        # Script de déploiement automatique via GitHub Actions (simplifié)

        set -e

        # Couleurs
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m'

        log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
        log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
        log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
        log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }

        # Configuration
        COMPOSE_FILE="docker-compose.yml"
        ENV_FILE=".env"
        APP_DIR="/srv/activibe"

        log_step "🚀 Démarrage du déploiement automatique (simplifié)..."

        # Arrêt propre des containers existants
        log_info "🛑 Arrêt des containers existants..."
        
        # Essayer d'arrêter avec docker compose si possible
        if [[ -f "$COMPOSE_FILE" ]]; then
            docker compose -f "$COMPOSE_FILE" down --remove-orphans 2>/dev/null || true
        fi
        
        # Arrêt forcé des containers connus au cas où
        for container in activibe-backend activibe-frontend activibe-phpmyadmin activibe-neo4j; do
            if docker ps --format '{{.Names}}' | grep -q "^$container$"; then
                log_info "🔄 Arrêt de $container..."
                docker stop "$container" 2>/dev/null || true
                docker rm "$container" 2>/dev/null || true
            fi
        done

        # Nettoyage des ressources orphelines
        log_info "🧹 Nettoyage des ressources orphelines..."
        docker container prune -f 2>/dev/null || true
        docker network prune -f 2>/dev/null || true

        # Mise à jour de APP_KEY dans .env
        log_info "🔑 Mise à jour de APP_KEY..."
        if [[ -f "update-env.sh" && -f ".env" ]]; then
            ./update-env.sh "$1"
        else
            log_warning "⚠️  Impossible de mettre à jour APP_KEY - fichiers manquants"
        fi

        # Configuration post-déploiement
        log_info "🔧 Configuration post-déploiement..."
        
        # Attendre que les conteneurs démarrent
        sleep 30
        
        # Créer le lien symbolique storage
        docker exec activibe-backend php /var/www/html/artisan storage:link 2>/dev/null || true
        
        # Exécuter les migrations automatiquement
        log_info "🗄️  Exécution des migrations de base de données..."
        docker exec activibe-backend php /var/www/html/artisan migrate --force 2>/dev/null || {
            log_warning "⚠️  Erreur lors des migrations, tentative de récupération..."
            docker exec activibe-backend php /var/www/html/artisan migrate:status 2>/dev/null || true
        }
        
        # Corriger CORS pour permettre l'accès frontend
        docker exec activibe-backend sed -i "/localhost:3000/a\\        'http://\$(curl -s ifconfig.me):3000'," /var/www/html/config/cors.php 2>/dev/null || true
        
        # Vider les caches
        docker exec activibe-backend php /var/www/html/artisan config:clear 2>/dev/null || true
        docker exec activibe-backend php /var/www/html/artisan route:clear 2>/dev/null || true

        # Pull de la dernière image
        log_info "📥 Récupération des dernières images Docker..."
        source ".env"
        docker pull "$1:latest" || { log_error "Impossible de pull l'image backend"; exit 1; }
        docker pull "$2:latest" || { log_error "Impossible de pull l'image frontend"; exit 1; }

        # Démarrage avec docker compose
        log_info "🚀 Démarrage des conteneurs..."
        docker compose -f "$COMPOSE_FILE" up -d --remove-orphans

        # Attente du démarrage
        log_info "⏳ Attente du démarrage des services (30 secondes)..."
        sleep 30

        # Vérification de l'état des services
        log_step "🔍 Vérification de l'état des services..."
        docker compose -f "$COMPOSE_FILE" ps

        # Tests de connectivité
        log_step "🧪 Tests de connectivité..."

        # Test du backend Laravel (port 8080)
        log_info "🔌 Test du port 8080 (Backend Laravel)..."
        if curl -f http://localhost:8080 >/dev/null 2>&1; then
            log_info "✅ Port 8080 (Backend Laravel) : Accessible"
        else
            log_warning "⚠️  Port 8080 (Backend Laravel) : Non accessible (peut nécessiter plus de temps)"
        fi

        # Test du frontend Nuxt.js (port 3000)
        log_info "🔌 Test du port 3000 (Frontend Nuxt.js)..."
        if curl -f http://localhost:3000 >/dev/null 2>&1; then
            log_info "✅ Port 3000 (Frontend Nuxt.js) : Accessible"
        else
            log_warning "⚠️  Port 3000 (Frontend Nuxt.js) : Non accessible (peut nécessiter plus de temps)"
        fi

        # Test port 7474 (Neo4j)
        log_info "🔌 Test du port 7474 (Neo4j)..."
        if curl -f http://localhost:7474 >/dev/null 2>&1; then
            log_info "✅ Port 7474 (Neo4j) : Accessible"
        else
            log_warning "⚠️  Port 7474 (Neo4j) : Non accessible"
        fi

        # Vérification des migrations
        log_info "🗄️  Vérification des migrations..."
        if docker exec activibe-backend php /var/www/html/artisan migrate:status >/dev/null 2>&1; then
            log_info "✅ Migrations : Toutes appliquées"
        else
            log_warning "⚠️  Migrations : Problème détecté"
        fi

        # Logs récents
        log_step "📋 Logs récents des conteneurs..."
        
        echo "=== Logs Backend (Laravel) ==="
        docker logs --tail=10 activibe-backend 2>/dev/null || log_warning "Pas de logs pour activibe-backend"
        
        echo "=== Logs Frontend (Nuxt.js) ==="
        docker logs --tail=10 activibe-frontend 2>/dev/null || log_warning "Pas de logs pour activibe-frontend"

        # Résumé final
        log_step "📊 RÉSUMÉ DU DÉPLOIEMENT"
        log_info "🎯 URLs d'accès :"
        log_info "   • Frontend Nuxt.js : http://$(curl -s ifconfig.me):3000"
        log_info "   • Backend Laravel API : http://$(curl -s ifconfig.me):8080"
        log_info "   • phpMyAdmin : http://$(curl -s ifconfig.me):8082"
        log_info "   • Neo4j Interface : http://$(curl -s ifconfig.me):7474"
        log_info "   • Infiswap Front (préservé) : http://$(curl -s ifconfig.me):80"
        
        log_step "✅ Déploiement automatique terminé !"
        EOF

        chmod +x auto-deploy.sh

        echo "🔧 Création des scripts de déploiement..."
        echo '#!/bin/bash' > deploy_production_server.sh
        echo 'echo "Deploiement des Conteneurs Docker"' >> deploy_production_server.sh
        echo 'docker compose down 2>/dev/null || true' >> deploy_production_server.sh
        echo 'docker compose pull' >> deploy_production_server.sh
        echo 'docker compose up -d' >> deploy_production_server.sh
        echo 'sleep 30' >> deploy_production_server.sh
        echo 'docker compose ps' >> deploy_production_server.sh
        echo 'echo "Deploiement termine !"' >> deploy_production_server.sh
        
        echo '#!/bin/bash' > test_production_containers.sh
        echo 'echo "🧪 Script de test des conteneurs en production"' >> test_production_containers.sh
        echo 'echo "=============================================="' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo '# Fonction de log' >> test_production_containers.sh
        echo 'log_info() {' >> test_production_containers.sh
        echo '    echo "ℹ️  $1"' >> test_production_containers.sh
        echo '}' >> test_production_containers.sh
        echo 'log_success() {' >> test_production_containers.sh
        echo '    echo "✅ $1"' >> test_production_containers.sh
        echo '}' >> test_production_containers.sh
        echo 'log_warning() {' >> test_production_containers.sh
        echo '    echo "⚠️  $1"' >> test_production_containers.sh
        echo '}' >> test_production_containers.sh
        echo 'log_error() {' >> test_production_containers.sh
        echo '    echo "❌ $1"' >> test_production_containers.sh
        echo '}' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo '# Test des conteneurs' >> test_production_containers.sh
        echo 'log_info "Vérification de l'\''état des conteneurs..."' >> test_production_containers.sh
        echo 'docker compose ps' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo '# Test de connectivité' >> test_production_containers.sh
        echo 'log_info "Tests de connectivité..."' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo '# Frontend' >> test_production_containers.sh
        echo 'if curl -f http://localhost:3000 >/dev/null 2>&1; then' >> test_production_containers.sh
        echo '    log_success "Frontend accessible"' >> test_production_containers.sh
        echo 'else' >> test_production_containers.sh
        echo '    log_warning "Frontend non accessible"' >> test_production_containers.sh
        echo 'fi' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo '# Backend' >> test_production_containers.sh
        echo 'if curl -f http://localhost:8080 >/dev/null 2>&1; then' >> test_production_containers.sh
        echo '    log_success "Backend accessible"' >> test_production_containers.sh
        echo 'else' >> test_production_containers.sh
        echo '    log_warning "Backend non accessible"' >> test_production_containers.sh
        echo 'fi' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo '# Neo4j' >> test_production_containers.sh
        echo 'if curl -f -H '\''Accept: application/json'\'' http://localhost:7474 >/dev/null 2>&1; then' >> test_production_containers.sh
        echo '    log_success "Neo4j accessible"' >> test_production_containers.sh
        echo 'else' >> test_production_containers.sh
        echo '    log_warning "Neo4j non accessible"' >> test_production_containers.sh
        echo 'fi' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo '# Test de l'\''API Laravel' >> test_production_containers.sh
        echo 'log_info "Test de l'\''API Laravel..."' >> test_production_containers.sh
        echo 'if curl -s -X POST http://localhost:8080/api/auth/login \\' >> test_production_containers.sh
        echo '    -H "Content-Type: application/json" \\' >> test_production_containers.sh
        echo '    -d '\''{"email":"test@test.com","password":"test"}'\'' | grep -q "Invalid credentials"; then' >> test_production_containers.sh
        echo '    log_success "API Laravel fonctionnelle"' >> test_production_containers.sh
        echo 'else' >> test_production_containers.sh
        echo '    log_warning "API Laravel non fonctionnelle"' >> test_production_containers.sh
        echo 'fi' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo '# Vérification des volumes' >> test_production_containers.sh
        echo 'log_info "Vérification des volumes Docker..."' >> test_production_containers.sh
        echo 'docker volume ls | grep activibe' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo 'echo "🧪 Tests terminés"' >> test_production_containers.sh
        echo '' >> test_production_containers.sh
        echo 'echo "Deploiement termine !"' >> test_production_containers.sh
        
        chmod +x deploy_production_server.sh
        chmod +x test_production_containers.sh

        echo "✅ Fichiers de configuration générés avec succès !"

    - name: 🔑 Configuration SSH
      run: |
        echo "🔧 Configuration de la connexion SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Configuration SSH pour éviter les vérifications d'hôte
        cat > ~/.ssh/config << EOF
        Host production-server
          HostName ${{ vars.SERVER_HOST }}
          User ${{ vars.SERVER_USERNAME }}
          Port ${{ vars.SERVER_PORT }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config

    - name: 📤 Déploiement sur le serveur avec Reverse Proxy
      run: |
        echo "🚀 Déploiement des fichiers sur le serveur avec architecture reverse proxy..."
        
        # Création du répertoire de déploiement
        ssh production-server "mkdir -p /srv/activibe && cd /srv/activibe"
        
        # Déploiement avec mise à jour du docker-compose.yml
        echo "📁 Mise à jour du docker-compose.yml et déploiement des images..."
        echo "✅ Le docker-compose.yml sera mis à jour avec les volumes nécessaires"
        
        # Copie du docker-compose.yml avec les volumes
        echo "📋 Copie du docker-compose.yml avec les volumes nécessaires..."
        scp docker-compose.yml production-server:/srv/activibe/docker-compose.yml
        
        # Pull intelligent et redémarrage des conteneurs
        echo "🎯 Pull intelligent des nouvelles images et redémarrage des conteneurs..."
        ssh production-server "cd /srv/activibe && docker compose down && docker compose pull && docker compose up -d"

    - name: 🧪 Tests post-déploiement avec Reverse Proxy
      run: |
        echo "🔍 Tests de vérification post-déploiement avec architecture reverse proxy..."
        
        # Attendre que les services soient complètement prêts
        echo "⏳ Attente du démarrage complet des services (60 secondes)..."
        sleep 60
        
        # Test de connectivité des services
        echo " Test des services sur le serveur..."
        
        # Test frontend (port 3000)
        if ssh production-server "curl -f http://localhost:3000" >/dev/null 2>&1; then
          echo "✅ Frontend (port 3000) : OK"
        else
          echo "⚠️  Frontend (port 3000) : KO (peut nécessiter plus de temps)"
        fi
        
        # Test API backend (port 8080) - test de connectivité simple
        if ssh production-server "curl -f http://localhost:8080" >/dev/null 2>&1; then
          echo "✅ API Backend (port 8080) : OK"
        else
          echo "⚠️  API Backend (port 8080) : KO (peut nécessiter plus de temps)"
        fi
        
        # Test Neo4j (port 7474) - test de connectivité avec headers
        if ssh production-server "curl -f -H 'Accept: application/json' http://localhost:7474" >/dev/null 2>&1; then
          echo "✅ Neo4j (port 7474) : OK"
        else
          echo "⚠️  Neo4j (port 7474) : KO"
        fi
        
        # Test de l'IP privée
        echo " Test de l'IP privée 10.0.0.244..."
        if ssh production-server "curl -f http://10.0.0.244:3000" >/dev/null 2>&1; then
          echo "✅ Frontend sur 10.0.0.244:3000 : OK"
        else
          echo "⚠️  Frontend sur 10.0.0.244:3000 : KO"
        fi
        
        if ssh production-server "curl -f http://10.0.0.244:8080" >/dev/null 2>&1; then
          echo "✅ API sur 10.0.0.244:8080 : OK"
        else
          echo "⚠️  API sur 10.0.0.244:8080 : KO"
        fi
        
        # Affichage de l'état des containers
        echo "📊 État des containers :"
        ssh production-server "cd /srv/activibe && docker compose -f docker-compose.yml ps"
        
        # Logs des conteneurs pour diagnostic
        echo "📋 Logs récents des conteneurs..."
        echo "=== Logs Backend ==="
        ssh production-server "cd /srv/activibe && docker logs --tail=10 activibe-backend"
        echo "=== Logs Frontend ==="
        ssh production-server "cd /srv/activibe && docker logs --tail=10 activibe-frontend"
        echo "=== Logs Neo4j ==="
        ssh production-server "cd /srv/activibe && docker logs --tail=10 activibe-neo4j"
        
        # Test API fonctionnel (POST vers login)
        echo "🧪 Test fonctionnel de l'API..."
        if ssh production-server 'curl -s -X POST http://localhost:8080/api/auth/login -H "Content-Type: application/json" -d "{\"email\":\"test@test.com\",\"password\":\"test\"}" | grep -q "Invalid credentials"'; then
          echo "✅ API fonctionnelle (endpoint login répond)"
        else
          echo "⚠️  API non fonctionnelle (endpoint login ne répond pas correctement)"
        fi

    - name: 📧 Notification de succès
      if: success()
      run: |
        echo "�� DÉPLOIEMENT RÉUSSI !"
        echo ""
        echo "🌐 L'application Acti'Vibe est maintenant accessible :"
        echo "   • Frontend Nuxt.js : http://10.0.0.244:3000 (via reverse proxy)"
        echo "   • Backend Laravel API : http://10.0.0.244:8080 (via reverse proxy)"
        echo "   • phpMyAdmin : http://10.0.0.244:8082"
        echo "   • Neo4j : http://10.0.0.244:7474"
        echo ""
        echo "🔧 Configuration requise sur le reverse proxy externe :"
        echo "   • activibe.be/ -> 10.0.0.244:3000"
        echo "   • activibe.be/api/* -> 10.0.0.244:8080/api/*"
        echo ""
        echo "🐳 Image déployée : ${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "📅 Date : $(date)"

    - name: 🚨 Notification d'échec
      if: failure()
      run: |
        echo "❌ ÉCHEC DU DÉPLOIEMENT !"
        echo ""
        echo "🔍 Vérifiez les logs ci-dessus pour identifier le problème."
        echo "📋 Points à vérifier :"
        echo "   • Connexion SSH au serveur"
        echo "   • Variables d'environnement GitHub"
        echo "   • Disponibilité de DockerHub"
        echo "   • État du serveur de production"
        echo ""
        echo "🆘 En cas de problème persistant, connectez-vous manuellement :"
        echo "   ssh ${{ vars.SERVER_USERNAME }}@${{ vars.SERVER_HOST }}"
        echo "   cd /srv/activibe && ./auto-deploy.sh"
