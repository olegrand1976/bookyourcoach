name: ğŸš€ DÃ©ploiement Production avec Corrections de SÃ©curitÃ©

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Ignorer le build (dÃ©ployer seulement)'
        required: false
        default: false
        type: boolean
      skip_deploy:
        description: 'Ignorer le dÃ©ploiement (build seulement)'
        required: false
        default: false
        type: boolean
      force_rebuild:
        description: 'Forcer la reconstruction des images'
        required: false
        default: false
        type: boolean
      security_fixes:
        description: 'Appliquer les corrections de sÃ©curitÃ©'
        required: false
        default: true
        type: boolean

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: ${{ vars.DOCKERHUB_USERNAME }}/activibe-app
  FRONTEND_IMAGE_NAME: ${{ vars.DOCKERHUB_USERNAME }}/activibe-frontend
  COMPOSE_FILE: docker-compose.yml
  ENV_FILE: production.env

jobs:
  # Job 1: PrÃ©paration et validation
  prepare:
    name: ğŸ” PrÃ©paration & Validation
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      image_tag: ${{ steps.check.outputs.image_tag }}
      apply_security: ${{ steps.check.outputs.apply_security }}
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ” VÃ©rification des conditions
      id: check
      run: |
        # DÃ©terminer si on doit builder (par dÃ©faut true sauf si explicitement false)
        SKIP_BUILD="${{ inputs.skip_build }}"
        if [[ "$SKIP_BUILD" == "true" ]]; then
          echo "should_build=false" >> $GITHUB_OUTPUT
        else
          echo "should_build=true" >> $GITHUB_OUTPUT
        fi
        
        # DÃ©terminer si on doit dÃ©ployer (par dÃ©faut true sauf si explicitement false)
        SKIP_DEPLOY="${{ inputs.skip_deploy }}"
        if [[ "$SKIP_DEPLOY" == "true" ]]; then
          echo "should_deploy=false" >> $GITHUB_OUTPUT
        else
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        fi
        
        # DÃ©terminer si on applique les corrections de sÃ©curitÃ© (par dÃ©faut true)
        SECURITY_FIXES="${{ inputs.security_fixes }}"
        if [[ "$SECURITY_FIXES" == "false" ]]; then
          echo "apply_security=false" >> $GITHUB_OUTPUT
        else
          echo "apply_security=true" >> $GITHUB_OUTPUT
        fi
        
        # GÃ©nÃ©rer le tag d'image
        FORCE_REBUILD="${{ inputs.force_rebuild }}"
        if [[ "$FORCE_REBUILD" == "true" ]]; then
          echo "image_tag=security-fix-$(date +%s)" >> $GITHUB_OUTPUT
        else
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ” Conditions vÃ©rifiÃ©es :"
        cat $GITHUB_OUTPUT

  # Job 2: VÃ©rification des corrections de sÃ©curitÃ©
  security-check:
    name: ğŸ”’ VÃ©rification SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.apply_security == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ” VÃ©rification des fichiers de sÃ©curitÃ©
      run: |
        echo "ğŸ”’ VÃ©rification des corrections de sÃ©curitÃ©..."
        
        # VÃ©rifier que les fichiers de sÃ©curitÃ© existent
        security_files=(
          "app/Http/Controllers/Api/AdminController.php"
          "app/Http/Controllers/Api/TeacherController.php"
          "app/Http/Controllers/Api/StudentController.php"
          "app/Http/Controllers/Api/FileUploadController.php"
          "routes/api.php"
          "routes/admin.php"
          "bootstrap/app.php"
        )
        
        missing_files=()
        for file in "${security_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… Fichier sÃ©curisÃ©: $file"
          else
            echo "âŒ Fichier manquant: $file"
            missing_files+=("$file")
          fi
        done
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "âŒ Fichiers de sÃ©curitÃ© manquants dÃ©tectÃ©s!"
          exit 1
        fi
        
        # VÃ©rifier la syntaxe PHP
        echo "ğŸ” VÃ©rification de la syntaxe PHP..."
        php -l routes/api.php
        php -l routes/admin.php
        php -l app/Http/Controllers/Api/AdminController.php
        php -l app/Http/Controllers/Api/TeacherController.php
        php -l app/Http/Controllers/Api/StudentController.php
        php -l app/Http/Controllers/Api/FileUploadController.php
        
        # VÃ©rifier l'absence d'authentification manuelle
        echo "ğŸ” VÃ©rification de l'authentification manuelle..."
        manual_auth=$(grep -c "request()->header('Authorization')" routes/api.php || echo "0")
        role_checks=$(grep -c "role !== 'admin'" routes/api.php || echo "0")
        
        if [ $manual_auth -gt 0 ]; then
          echo "âŒ Authentifications manuelles dÃ©tectÃ©es: $manual_auth"
          exit 1
        fi
        
        if [ $role_checks -gt 0 ]; then
          echo "âŒ VÃ©rifications de rÃ´le dÃ©tectÃ©es: $role_checks"
          exit 1
        fi
        
        echo "âœ… Toutes les vÃ©rifications de sÃ©curitÃ© sont passÃ©es!"
        echo "  - Authentifications manuelles: $manual_auth"
        echo "  - VÃ©rifications de rÃ´le: $role_checks"

  # Job 3: Build des images Docker
  build-images:
    name: ğŸ—ï¸ Build Images Docker
    runs-on: ubuntu-latest
    needs: [prepare, security-check]
    if: needs.prepare.outputs.should_build == 'true'
    outputs:
      backend_image: ${{ steps.build-backend.outputs.image }}
      frontend_image: ${{ steps.build-frontend.outputs.image }}
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Configuration Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Connexion DockerHub
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
    
    - name: ğŸ—ï¸ Build Backend (Laravel) avec corrections de sÃ©curitÃ©
      id: build-backend
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:latest
          ${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}
          ${{ env.IMAGE_NAME }}:security-fixed
        cache-from: type=gha,scope=backend
        cache-to: type=gha,mode=max,scope=backend
        build-args: |
          SECURITY_FIXES=true
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
      continue-on-error: false

    - name: ğŸ¨ Build Frontend (Nuxt.js)
      id: build-frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.FRONTEND_IMAGE_NAME }}:latest
          ${{ env.FRONTEND_IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}
        cache-from: type=gha,scope=frontend
        cache-to: type=gha,mode=max,scope=frontend
      continue-on-error: false

    - name: ğŸ“‹ RÃ©sumÃ© du build
      run: |
        echo "âœ… Build terminÃ© avec succÃ¨s !"
        echo "ğŸ—ï¸ Images construites avec corrections de sÃ©curitÃ© :"
        echo "  - Backend: ${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}"
        echo "  - Frontend: ${{ env.FRONTEND_IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}"
        echo "ğŸ”’ Corrections de sÃ©curitÃ© intÃ©grÃ©es :"
        echo "  - Authentification centralisÃ©e avec auth:sanctum"
        echo "  - Middlewares de rÃ´les appropriÃ©s"
        echo "  - ContrÃ´leurs sÃ©curisÃ©s"
        echo "  - Suppression de l'authentification manuelle"

  # Job 4: GÃ©nÃ©ration des fichiers de configuration avec sÃ©curitÃ©
  generate-config:
    name: âš™ï¸ GÃ©nÃ©ration Configuration SÃ©curisÃ©e
    runs-on: ubuntu-latest
    needs: [prepare, build-images]
    if: needs.prepare.outputs.should_deploy == 'true'
    outputs:
      config_files: ${{ steps.generate.outputs.files }}
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ GÃ©nÃ©ration des fichiers de configuration sÃ©curisÃ©s
      id: generate
      run: |
        echo "ğŸ”§ GÃ©nÃ©ration des fichiers de configuration avec sÃ©curitÃ©..."
        
        # GÃ©nÃ©rer APP_KEY
        APP_KEY=$(openssl rand -base64 32)
        
        # CrÃ©er docker-compose.yml avec sÃ©curitÃ© renforcÃ©e
        cat > docker-compose.yml << 'EOF'
        services:
          # Backend Laravel API avec sÃ©curitÃ© renforcÃ©e
          backend:
            image: ${IMAGE_NAME:-${{ env.IMAGE_NAME }}:latest}
            container_name: activibe-backend
            restart: unless-stopped
            env_file:
              - ./.env
            ports:
              - "8080:80"
            volumes:
              - app_storage:/var/www/html/storage
              - app_bootstrap_cache:/var/www/html/bootstrap/cache
              - /srv/activibe/cert.pem:/var/www/html/cert.pem:ro
              - /srv/activibe/.env:/var/www/html/.env:ro
            depends_on:
              - neo4j
            networks:
              - app-network
            security_opt:
              - no-new-privileges:true
            read_only: true
            tmpfs:
              - /tmp:mode=1777
              - /var/tmp:mode=1777
              - /run:mode=755
              - /var/run:mode=755

          # Frontend Nuxt.js
          frontend:
            image: ${FRONTEND_IMAGE_NAME:-${{ env.FRONTEND_IMAGE_NAME }}:latest}
            container_name: activibe-frontend
            restart: unless-stopped
            ports:
              - "3000:3000"
            environment:
              - NUXT_PUBLIC_API_BASE=https://activibe.be/api
              - NUXT_API_BASE=http://activibe-backend:80/api
              - NITRO_HOST=0.0.0.0
              - NITRO_PORT=3000
            depends_on:
              - backend
            networks:
              - app-network
            security_opt:
              - no-new-privileges:true

          # phpMyAdmin
          phpmyadmin:
            image: phpmyadmin:latest
            container_name: activibe-phpmyadmin
            restart: unless-stopped
            ports:
              - "8082:80"
            environment:
              - PMA_HOST=${DB_HOST}
              - PMA_PORT=${DB_PORT}
              - PMA_USER=${DB_USERNAME}
              - PMA_PASSWORD=${DB_PASSWORD}
              - UPLOAD_LIMIT=256M
              - MEMORY_LIMIT=512M
            networks:
              - app-network
            security_opt:
              - no-new-privileges:true

          # Neo4j
          neo4j:
            image: neo4j:5.15-community
            container_name: activibe-neo4j
            restart: unless-stopped
            ports:
              - "7474:7474"
              - "7687:7687"
            environment:
              - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
              - NEO4J_PLUGINS=["apoc"]
              - NEO4J_dbms_security_procedures_unrestricted=apoc.*
              - NEO4J_dbms_security_procedures_allowlist=apoc.*
            volumes:
              - neo4j_data:/data
              - neo4j_logs:/logs
              - neo4j_import:/var/lib/neo4j/import
              - neo4j_plugins:/plugins
            networks:
              - app-network
            security_opt:
              - no-new-privileges:true

        volumes:
          neo4j_data:
            driver: local
          neo4j_logs:
            driver: local
          neo4j_import:
            driver: local
          neo4j_plugins:
            driver: local
          app_storage:
            driver: local
          app_bootstrap_cache:
            driver: local

        networks:
          app-network:
            driver: bridge
        EOF

        # CrÃ©er le script de dÃ©ploiement sÃ©curisÃ©
        cat > auto-deploy-secure.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Couleurs
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m'

        log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
        log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
        log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
        log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }

        COMPOSE_FILE="docker-compose.yml"
        ENV_FILE=".env"

        log_step "ğŸš€ DÃ©marrage du dÃ©ploiement sÃ©curisÃ©..."

        # ArrÃªt propre des containers existants
        log_info "ğŸ›‘ ArrÃªt des containers existants..."
        if [[ -f "$COMPOSE_FILE" ]]; then
            docker compose -f "$COMPOSE_FILE" down --remove-orphans 2>/dev/null || true
        fi

        # Nettoyage des ressources orphelines
        log_info "ğŸ§¹ Nettoyage des ressources orphelines..."
        docker container prune -f 2>/dev/null || true
        docker network prune -f 2>/dev/null || true

        # Pull des images avec corrections de sÃ©curitÃ©
        log_info "ğŸ“¥ RÃ©cupÃ©ration des images avec corrections de sÃ©curitÃ©..."
        source ".env"
        docker pull "$2:latest" || { log_error "Impossible de pull l'image backend"; exit 1; }
        docker pull "$3:latest" || { log_error "Impossible de pull l'image frontend"; exit 1; }

        # DÃ©marrage avec docker compose
        log_info "ğŸš€ DÃ©marrage des conteneurs sÃ©curisÃ©s..."
        docker compose -f "$COMPOSE_FILE" up -d --remove-orphans

        # Attente du dÃ©marrage des conteneurs
        log_info "â³ Attente du dÃ©marrage des services (30 secondes)..."
        sleep 30

        # VÃ©rification de la connexion Ã  la base de donnÃ©es
        log_info "ğŸ” VÃ©rification de la connexion Ã  la base de donnÃ©es..."
        if ! docker compose -f "$COMPOSE_FILE" exec -T backend php artisan db:show >/dev/null 2>&1; then
          log_error "âŒ Impossible de se connecter Ã  la base de donnÃ©es"
          log_info "â³ Attente supplÃ©mentaire (30 secondes)..."
          sleep 30
          if ! docker compose -f "$COMPOSE_FILE" exec -T backend php artisan db:show >/dev/null 2>&1; then
            log_error "âŒ La base de donnÃ©es n'est toujours pas accessible"
            exit 1
          fi
        fi
        log_info "âœ… Connexion Ã  la base de donnÃ©es Ã©tablie"
        
        # ExÃ©cution des migrations de base de donnÃ©es avec vÃ©rification
        log_info "ğŸ—„ï¸  ExÃ©cution des migrations de base de donnÃ©es..."
        
        # VÃ©rifier l'Ã©tat des migrations avant
        log_info "ğŸ“Š VÃ©rification de l'Ã©tat des migrations avant exÃ©cution..."
        MIGRATIONS_BEFORE=$(docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate:status 2>/dev/null || echo "")
        PENDING_BEFORE=$(echo "$MIGRATIONS_BEFORE" | grep -c "Pending" || echo "0")
        log_info "ğŸ“ˆ Migrations en attente avant : $PENDING_BEFORE"
        if [ "$PENDING_BEFORE" -gt 0 ]; then
          log_info "ğŸ“‹ Liste des migrations en attente :"
          echo "$MIGRATIONS_BEFORE" | grep "Pending" || true
        fi
        
        # ExÃ©cuter les migrations
        log_step "ğŸš€ ExÃ©cution des migrations..."
        MIGRATION_OUTPUT=$(docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate --force 2>&1)
        MIGRATION_EXIT_CODE=$?
        
        if [ $MIGRATION_EXIT_CODE -eq 0 ]; then
          log_info "âœ… Migrations exÃ©cutÃ©es avec succÃ¨s"
          echo "$MIGRATION_OUTPUT" | tail -20
          
          # VÃ©rifier l'Ã©tat aprÃ¨s migration
          log_info "ğŸ“Š VÃ©rification de l'Ã©tat des migrations aprÃ¨s exÃ©cution..."
          sleep 3
          MIGRATIONS_AFTER=$(docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate:status 2>/dev/null || echo "")
          PENDING_AFTER=$(echo "$MIGRATIONS_AFTER" | grep -c "Pending" || echo "0")
          
          if [ "$PENDING_AFTER" -gt 0 ]; then
            log_warning "âš ï¸  Il reste $PENDING_AFTER migration(s) en attente"
            log_info "ğŸ“‹ Liste des migrations en attente :"
            echo "$MIGRATIONS_AFTER" | grep "Pending" || true
            
            # RÃ©essayer une fois aprÃ¨s une courte pause
            log_info "ğŸ”„ Nouvelle tentative d'exÃ©cution des migrations..."
            sleep 5
            if docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate --force; then
              log_info "âœ… Migrations complÃ©mentaires exÃ©cutÃ©es"
            else
              log_error "âŒ Ã‰chec de l'exÃ©cution des migrations complÃ©mentaires"
              log_warning "âš ï¸  VÃ©rifiez les logs pour identifier le problÃ¨me"
            fi
          else
            log_info "âœ… Toutes les migrations ont Ã©tÃ© appliquÃ©es avec succÃ¨s"
          fi
        else
          log_error "âŒ Ã‰chec de l'exÃ©cution des migrations"
          log_error "ğŸ“‹ DÃ©tails de l'erreur :"
          echo "$MIGRATION_OUTPUT" | tail -30
          
          # En production, on ne fait JAMAIS de migrate:refresh (trop dangereux)
          log_warning "âš ï¸  Tentative de rÃ©paration sÃ©curisÃ©e..."
          
          # Essayer de rÃ©parer seulement les migrations spÃ©cifiques qui ont Ã©chouÃ©
          log_info "ğŸ”„ Nouvelle tentative d'exÃ©cution des migrations..."
          sleep 5
          if docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate --force; then
            log_info "âœ… Migrations rÃ©parÃ©es avec succÃ¨s"
          else
            log_error "âŒ Ã‰chec dÃ©finitif des migrations"
            log_error "âš ï¸  ACTION REQUISE : VÃ©rifiez manuellement les migrations en Ã©chec"
            log_error "   Commande Ã  exÃ©cuter : docker compose -f $COMPOSE_FILE exec backend php artisan migrate:status"
            exit 1
          fi
        fi
        
        # VÃ©rification finale
        log_step "ğŸ” VÃ©rification finale de l'Ã©tat des migrations..."
        FINAL_STATUS=$(docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate:status 2>/dev/null || echo "")
        if echo "$FINAL_STATUS" | grep -q "Pending"; then
          PENDING_COUNT=$(echo "$FINAL_STATUS" | grep -c "Pending" || echo "0")
          log_warning "âš ï¸  Attention : $PENDING_COUNT migration(s) restent en attente"
          log_info "ğŸ“‹ Ã‰tat final des migrations :"
          echo "$FINAL_STATUS" | grep -E "(Pending|Ran)" | head -20
        else
          log_info "âœ… Toutes les migrations sont appliquÃ©es"
        fi

        # Initialisation de l'application avec sÃ©curitÃ© (erreurs non critiques)
        log_info "ğŸ”§ Initialisation de l'application..."
        docker compose -f "$COMPOSE_FILE" exec -T backend php artisan route:clear || log_warning "âš ï¸  Impossible de clear les routes (non critique)"
        docker compose -f "$COMPOSE_FILE" exec -T backend php artisan config:clear || log_warning "âš ï¸  Impossible de clear la config (non critique)"
        docker compose -f "$COMPOSE_FILE" exec -T backend php artisan cache:clear || log_warning "âš ï¸  Impossible de clear le cache (non critique)"
        docker compose -f "$COMPOSE_FILE" exec -T backend php artisan view:clear || log_warning "âš ï¸  Impossible de clear les vues (non critique)"

        # VÃ©rification de l'Ã©tat des services
        log_step "ğŸ” VÃ©rification de l'Ã©tat des services..."
        docker compose -f "$COMPOSE_FILE" ps

        log_step "âœ… DÃ©ploiement sÃ©curisÃ© terminÃ© !"
        log_info "ğŸ”’ Corrections de sÃ©curitÃ© appliquÃ©es :"
        log_info "  - Authentification centralisÃ©e avec auth:sanctum"
        log_info "  - Middlewares de rÃ´les appropriÃ©s"
        log_info "  - Suppression de l'authentification manuelle"
        log_info "  - ContrÃ´leurs sÃ©curisÃ©s"
        EOF
        
        chmod +x auto-deploy-secure.sh

        echo "files=docker-compose.yml,auto-deploy-secure.sh" >> $GITHUB_OUTPUT
        echo "âœ… Fichiers de configuration sÃ©curisÃ©s gÃ©nÃ©rÃ©s avec succÃ¨s !"

  # Job 5: DÃ©ploiement sur le serveur avec sÃ©curitÃ©
  deploy:
    name: ğŸš€ DÃ©ploiement Serveur SÃ©curisÃ©
    runs-on: ubuntu-latest
    needs: [prepare, build-images, generate-config]
    if: needs.prepare.outputs.should_deploy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Configuration SSH
      run: |
        echo "ğŸ”§ Configuration de la connexion SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        cat > ~/.ssh/config << EOF
        Host production-server
          HostName ${{ vars.SERVER_HOST }}
          User ${{ vars.SERVER_USERNAME }}
          Port ${{ vars.SERVER_PORT }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config

    - name: âš™ï¸ GÃ©nÃ©ration des fichiers de configuration sÃ©curisÃ©s
      run: |
        echo "ğŸ”§ GÃ©nÃ©ration des fichiers de configuration avec sÃ©curitÃ©..."
        
        # GÃ©nÃ©rer APP_KEY
        APP_KEY=$(openssl rand -base64 32)
        
        # CrÃ©er docker-compose.yml avec sÃ©curitÃ© renforcÃ©e
        cat > docker-compose.yml << 'EOF'
        services:
          # Backend Laravel API avec sÃ©curitÃ© renforcÃ©e
          backend:
            image: ${IMAGE_NAME:-${{ env.IMAGE_NAME }}:latest}
            container_name: activibe-backend
            restart: unless-stopped
            env_file:
              - ./.env
            ports:
              - "8080:80"
            volumes:
              - app_storage:/var/www/html/storage
              - app_bootstrap_cache:/var/www/html/bootstrap/cache
              - /srv/activibe/cert.pem:/var/www/html/cert.pem:ro
              - /srv/activibe/.env:/var/www/html/.env:ro
            depends_on:
              - neo4j
            networks:
              - app-network
            security_opt:
              - no-new-privileges:true
            read_only: true
            tmpfs:
              - /tmp:mode=1777
              - /var/tmp:mode=1777
              - /run:mode=755
              - /var/run:mode=755

          # Frontend Nuxt.js
          frontend:
            image: ${FRONTEND_IMAGE_NAME:-${{ env.FRONTEND_IMAGE_NAME }}:latest}
            container_name: activibe-frontend
            restart: unless-stopped
            ports:
              - "3000:3000"
            environment:
              - NUXT_PUBLIC_API_BASE=https://activibe.be/api
              - NUXT_API_BASE=http://activibe-backend:80/api
              - NITRO_HOST=0.0.0.0
              - NITRO_PORT=3000
            depends_on:
              - backend
            networks:
              - app-network
            security_opt:
              - no-new-privileges:true

          # phpMyAdmin
          phpmyadmin:
            image: phpmyadmin:latest
            container_name: activibe-phpmyadmin
            restart: unless-stopped
            ports:
              - "8082:80"
            environment:
              - PMA_HOST=${DB_HOST}
              - PMA_PORT=${DB_PORT}
              - PMA_USER=${DB_USERNAME}
              - PMA_PASSWORD=${DB_PASSWORD}
              - UPLOAD_LIMIT=256M
              - MEMORY_LIMIT=512M
            networks:
              - app-network
            security_opt:
              - no-new-privileges:true

          # Neo4j
          neo4j:
            image: neo4j:5.15-community
            container_name: activibe-neo4j
            restart: unless-stopped
            ports:
              - "7474:7474"
              - "7687:7687"
            environment:
              - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
              - NEO4J_PLUGINS=["apoc"]
              - NEO4J_dbms_security_procedures_unrestricted=apoc.*
              - NEO4J_dbms_security_procedures_allowlist=apoc.*
            volumes:
              - neo4j_data:/data
              - neo4j_logs:/logs
              - neo4j_import:/var/lib/neo4j/import
              - neo4j_plugins:/plugins
            networks:
              - app-network
            security_opt:
              - no-new-privileges:true

        volumes:
          neo4j_data:
            driver: local
          neo4j_logs:
            driver: local
          neo4j_import:
            driver: local
          neo4j_plugins:
            driver: local
          app_storage:
            driver: local
          app_bootstrap_cache:
            driver: local

        networks:
          app-network:
            driver: bridge
        EOF

        # CrÃ©er le script de dÃ©ploiement sÃ©curisÃ©
        cat > auto-deploy-secure.sh << 'EOF'
        #!/bin/bash
        set -e
        
        # Couleurs
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m'

        log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
        log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
        log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
        log_step() { echo -e "${BLUE}[STEP]${NC} $1"; }

        COMPOSE_FILE="docker-compose.yml"
        ENV_FILE=".env"

        log_step "ğŸš€ DÃ©marrage du dÃ©ploiement sÃ©curisÃ©..."

        # ArrÃªt propre des containers existants
        log_info "ğŸ›‘ ArrÃªt des containers existants..."
        if [[ -f "$COMPOSE_FILE" ]]; then
            docker compose -f "$COMPOSE_FILE" down --remove-orphans 2>/dev/null || true
        fi

        # Nettoyage des ressources orphelines
        log_info "ğŸ§¹ Nettoyage des ressources orphelines..."
        docker container prune -f 2>/dev/null || true
        docker network prune -f 2>/dev/null || true

        # Pull des images avec corrections de sÃ©curitÃ©
        log_info "ğŸ“¥ RÃ©cupÃ©ration des images avec corrections de sÃ©curitÃ©..."
        source ".env"
        docker pull "$2:latest" || { log_error "Impossible de pull l'image backend"; exit 1; }
        docker pull "$3:latest" || { log_error "Impossible de pull l'image frontend"; exit 1; }

        # DÃ©marrage avec docker compose
        log_info "ğŸš€ DÃ©marrage des conteneurs sÃ©curisÃ©s..."
        docker compose -f "$COMPOSE_FILE" up -d --remove-orphans

        # Attente du dÃ©marrage des conteneurs
        log_info "â³ Attente du dÃ©marrage des services (30 secondes)..."
        sleep 30

        # VÃ©rification de la connexion Ã  la base de donnÃ©es
        log_info "ğŸ” VÃ©rification de la connexion Ã  la base de donnÃ©es..."
        if ! docker compose -f "$COMPOSE_FILE" exec -T backend php artisan db:show >/dev/null 2>&1; then
          log_error "âŒ Impossible de se connecter Ã  la base de donnÃ©es"
          log_info "â³ Attente supplÃ©mentaire (30 secondes)..."
          sleep 30
          if ! docker compose -f "$COMPOSE_FILE" exec -T backend php artisan db:show >/dev/null 2>&1; then
            log_error "âŒ La base de donnÃ©es n'est toujours pas accessible"
            exit 1
          fi
        fi
        log_info "âœ… Connexion Ã  la base de donnÃ©es Ã©tablie"
        
        # ExÃ©cution des migrations de base de donnÃ©es avec vÃ©rification
        log_info "ğŸ—„ï¸  ExÃ©cution des migrations de base de donnÃ©es..."
        
        # VÃ©rifier l'Ã©tat des migrations avant
        log_info "ğŸ“Š VÃ©rification de l'Ã©tat des migrations avant exÃ©cution..."
        MIGRATIONS_BEFORE=$(docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate:status 2>/dev/null || echo "")
        PENDING_BEFORE=$(echo "$MIGRATIONS_BEFORE" | grep -c "Pending" || echo "0")
        log_info "ğŸ“ˆ Migrations en attente avant : $PENDING_BEFORE"
        if [ "$PENDING_BEFORE" -gt 0 ]; then
          log_info "ğŸ“‹ Liste des migrations en attente :"
          echo "$MIGRATIONS_BEFORE" | grep "Pending" || true
        fi
        
        # ExÃ©cuter les migrations
        log_step "ğŸš€ ExÃ©cution des migrations..."
        MIGRATION_OUTPUT=$(docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate --force 2>&1)
        MIGRATION_EXIT_CODE=$?
        
        if [ $MIGRATION_EXIT_CODE -eq 0 ]; then
          log_info "âœ… Migrations exÃ©cutÃ©es avec succÃ¨s"
          echo "$MIGRATION_OUTPUT" | tail -20
          
          # VÃ©rifier l'Ã©tat aprÃ¨s migration
          log_info "ğŸ“Š VÃ©rification de l'Ã©tat des migrations aprÃ¨s exÃ©cution..."
          sleep 3
          MIGRATIONS_AFTER=$(docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate:status 2>/dev/null || echo "")
          PENDING_AFTER=$(echo "$MIGRATIONS_AFTER" | grep -c "Pending" || echo "0")
          
          if [ "$PENDING_AFTER" -gt 0 ]; then
            log_warning "âš ï¸  Il reste $PENDING_AFTER migration(s) en attente"
            log_info "ğŸ“‹ Liste des migrations en attente :"
            echo "$MIGRATIONS_AFTER" | grep "Pending" || true
            
            # RÃ©essayer une fois aprÃ¨s une courte pause
            log_info "ğŸ”„ Nouvelle tentative d'exÃ©cution des migrations..."
            sleep 5
            if docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate --force; then
              log_info "âœ… Migrations complÃ©mentaires exÃ©cutÃ©es"
            else
              log_error "âŒ Ã‰chec de l'exÃ©cution des migrations complÃ©mentaires"
              log_warning "âš ï¸  VÃ©rifiez les logs pour identifier le problÃ¨me"
            fi
          else
            log_info "âœ… Toutes les migrations ont Ã©tÃ© appliquÃ©es avec succÃ¨s"
          fi
        else
          log_error "âŒ Ã‰chec de l'exÃ©cution des migrations"
          log_error "ğŸ“‹ DÃ©tails de l'erreur :"
          echo "$MIGRATION_OUTPUT" | tail -30
          
          # En production, on ne fait JAMAIS de migrate:refresh (trop dangereux)
          log_warning "âš ï¸  Tentative de rÃ©paration sÃ©curisÃ©e..."
          
          # Essayer de rÃ©parer seulement les migrations spÃ©cifiques qui ont Ã©chouÃ©
          log_info "ğŸ”„ Nouvelle tentative d'exÃ©cution des migrations..."
          sleep 5
          if docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate --force; then
            log_info "âœ… Migrations rÃ©parÃ©es avec succÃ¨s"
          else
            log_error "âŒ Ã‰chec dÃ©finitif des migrations"
            log_error "âš ï¸  ACTION REQUISE : VÃ©rifiez manuellement les migrations en Ã©chec"
            log_error "   Commande Ã  exÃ©cuter : docker compose -f $COMPOSE_FILE exec backend php artisan migrate:status"
            exit 1
          fi
        fi
        
        # VÃ©rification finale
        log_step "ğŸ” VÃ©rification finale de l'Ã©tat des migrations..."
        FINAL_STATUS=$(docker compose -f "$COMPOSE_FILE" exec -T backend php artisan migrate:status 2>/dev/null || echo "")
        if echo "$FINAL_STATUS" | grep -q "Pending"; then
          PENDING_COUNT=$(echo "$FINAL_STATUS" | grep -c "Pending" || echo "0")
          log_warning "âš ï¸  Attention : $PENDING_COUNT migration(s) restent en attente"
          log_info "ğŸ“‹ Ã‰tat final des migrations :"
          echo "$FINAL_STATUS" | grep -E "(Pending|Ran)" | head -20
        else
          log_info "âœ… Toutes les migrations sont appliquÃ©es"
        fi

        # Initialisation de l'application avec sÃ©curitÃ© (erreurs non critiques)
        log_info "ğŸ”§ Initialisation de l'application..."
        docker compose -f "$COMPOSE_FILE" exec -T backend php artisan route:clear || log_warning "âš ï¸  Impossible de clear les routes (non critique)"
        docker compose -f "$COMPOSE_FILE" exec -T backend php artisan config:clear || log_warning "âš ï¸  Impossible de clear la config (non critique)"
        docker compose -f "$COMPOSE_FILE" exec -T backend php artisan cache:clear || log_warning "âš ï¸  Impossible de clear le cache (non critique)"
        docker compose -f "$COMPOSE_FILE" exec -T backend php artisan view:clear || log_warning "âš ï¸  Impossible de clear les vues (non critique)"

        # VÃ©rification de l'Ã©tat des services
        log_step "ğŸ” VÃ©rification de l'Ã©tat des services..."
        docker compose -f "$COMPOSE_FILE" ps

        log_step "âœ… DÃ©ploiement sÃ©curisÃ© terminÃ© !"
        log_info "ğŸ”’ Corrections de sÃ©curitÃ© appliquÃ©es :"
        log_info "  - Authentification centralisÃ©e avec auth:sanctum"
        log_info "  - Middlewares de rÃ´les appropriÃ©s"
        log_info "  - Suppression de l'authentification manuelle"
        log_info "  - ContrÃ´leurs sÃ©curisÃ©s"
        EOF
        
        chmod +x auto-deploy-secure.sh

        echo "âœ… Fichiers de configuration sÃ©curisÃ©s gÃ©nÃ©rÃ©s avec succÃ¨s !"

    - name: ğŸ“¤ DÃ©ploiement des fichiers sÃ©curisÃ©s
      run: |
        echo "ğŸš€ DÃ©ploiement des fichiers sÃ©curisÃ©s sur le serveur..."
        
        # CrÃ©ation du rÃ©pertoire de dÃ©ploiement
        ssh production-server "mkdir -p /srv/activibe && cd /srv/activibe"
        
        # Copie des fichiers de configuration sÃ©curisÃ©s
        echo "ğŸ“‹ Copie des fichiers de configuration sÃ©curisÃ©s..."
        scp docker-compose.yml production-server:/srv/activibe/docker-compose.yml
        scp auto-deploy-secure.sh production-server:/srv/activibe/auto-deploy-secure.sh
        
        # ExÃ©cution du dÃ©ploiement sÃ©curisÃ©
        echo "ğŸ¯ ExÃ©cution du dÃ©ploiement sÃ©curisÃ©..."
        ssh production-server "cd /srv/activibe && chmod +x *.sh && ./auto-deploy-secure.sh '${{ needs.prepare.outputs.image_tag }}' '${{ env.IMAGE_NAME }}' '${{ env.FRONTEND_IMAGE_NAME }}'"

  # Job 6: Tests post-dÃ©ploiement avec sÃ©curitÃ© (non bloquant)
  test-deployment:
    name: ğŸ§ª Tests Post-DÃ©ploiement SÃ©curisÃ©
    runs-on: ubuntu-latest
    needs: [prepare, deploy, generate-config]
    if: needs.prepare.outputs.should_deploy == 'true'
    continue-on-error: true
    
    steps:
    - name: ğŸ”‘ Configuration SSH
      run: |
        echo "ğŸ”§ Configuration de la connexion SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        cat > ~/.ssh/config << EOF
        Host production-server
          HostName ${{ vars.SERVER_HOST }}
          User ${{ vars.SERVER_USERNAME }}
          Port ${{ vars.SERVER_PORT }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        
        chmod 600 ~/.ssh/config

    - name: ğŸ§ª Tests de connectivitÃ© et sÃ©curitÃ©
      run: |
        echo "ğŸ” Tests de vÃ©rification post-dÃ©ploiement avec sÃ©curitÃ©..."
        
        # Attendre que les services soient prÃªts
        echo "â³ Attente du dÃ©marrage complet des services (30 secondes)..."
        sleep 30
        
        # Test de connectivitÃ© des services
        echo "ğŸ”Œ Test des services sur le serveur..."
        
        # Test frontend (port 3000)
        if ssh production-server "curl -f http://localhost:3000" >/dev/null 2>&1; then
          echo "âœ… Frontend (port 3000) : OK"
        else
          echo "âš ï¸  Frontend (port 3000) : KO"
        fi
        
        # Test API backend (port 8080)
        if ssh production-server "curl -f http://localhost:8080" >/dev/null 2>&1; then
          echo "âœ… API Backend (port 8080) : OK"
        else
          echo "âš ï¸  API Backend (port 8080) : KO"
        fi
        
        # Test Neo4j (port 7474)
        if ssh production-server "curl -f -H 'Accept: application/json' http://localhost:7474" >/dev/null 2>&1; then
          echo "âœ… Neo4j (port 7474) : OK"
        else
          echo "âš ï¸  Neo4j (port 7474) : KO"
        fi
        
        # Test de l'IP privÃ©e
        echo "ğŸ”Œ Test de l'IP privÃ©e 10.0.0.244..."
        if ssh production-server "curl -f http://10.0.0.244:3000" >/dev/null 2>&1; then
          echo "âœ… Frontend sur 10.0.0.244:3000 : OK"
        else
          echo "âš ï¸  Frontend sur 10.0.0.244:3000 : KO"
        fi
        
        if ssh production-server "curl -f http://10.0.0.244:8080" >/dev/null 2>&1; then
          echo "âœ… API sur 10.0.0.244:8080 : OK"
        else
          echo "âš ï¸  API sur 10.0.0.244:8080 : KO"
        fi
        
        # Affichage de l'Ã©tat des containers
        echo "ğŸ“Š Ã‰tat des containers :"
        ssh production-server "cd /srv/activibe && docker compose -f docker-compose.yml ps"
        
        # Tests de sÃ©curitÃ© des routes
        echo "ğŸ”’ Tests de sÃ©curitÃ© des routes..."
        
        # Test route admin avec token invalide
        admin_response=$(ssh production-server 'curl -s -w "%{http_code}" -H "Authorization: Bearer invalid_token" http://localhost:8080/api/admin/dashboard' 2>/dev/null)
        admin_http_code=$(echo "$admin_response" | tail -c 4)
        
        if [ "$admin_http_code" = "401" ]; then
          echo "âœ… Routes admin sÃ©curisÃ©es (HTTP $admin_http_code)"
        else
          echo "âš ï¸  Routes admin non sÃ©curisÃ©es (HTTP $admin_http_code)"
        fi
        
        # Test route teacher avec token invalide
        teacher_response=$(ssh production-server 'curl -s -w "%{http_code}" -H "Authorization: Bearer invalid_token" http://localhost:8080/api/teacher/dashboard' 2>/dev/null)
        teacher_http_code=$(echo "$teacher_response" | tail -c 4)
        
        if [ "$teacher_http_code" = "401" ]; then
          echo "âœ… Routes teacher sÃ©curisÃ©es (HTTP $teacher_http_code)"
        else
          echo "âš ï¸  Routes teacher non sÃ©curisÃ©es (HTTP $teacher_http_code)"
        fi
        
        # Test route student avec token invalide
        student_response=$(ssh production-server 'curl -s -w "%{http_code}" -H "Authorization: Bearer invalid_token" http://localhost:8080/api/student/dashboard' 2>/dev/null)
        student_http_code=$(echo "$student_response" | tail -c 4)
        
        if [ "$student_http_code" = "401" ]; then
          echo "âœ… Routes student sÃ©curisÃ©es (HTTP $student_http_code)"
        else
          echo "âš ï¸  Routes student non sÃ©curisÃ©es (HTTP $student_http_code)"
        fi
        
        # Test API fonctionnel
        echo "ğŸ§ª Test fonctionnel de l'API..."
        if ssh production-server 'curl -s -X POST http://localhost:8080/api/auth/login -H "Content-Type: application/json" -d "{\"email\":\"test@test.com\",\"password\":\"test\"}" | grep -q "Invalid credentials"'; then
          echo "âœ… API fonctionnelle (endpoint login rÃ©pond)"
        else
          echo "âš ï¸  API non fonctionnelle (endpoint login ne rÃ©pond pas correctement)"
        fi

  # Job 7: Notifications avec sÃ©curitÃ©
  notify:
    name: ğŸ“§ Notifications SÃ©curisÃ©es
    runs-on: ubuntu-latest
    needs: [prepare, build-images, deploy, test-deployment]
    if: always()
    
    steps:
    - name: ğŸ“§ Notification de succÃ¨s avec sÃ©curitÃ©
      if: needs.deploy.result == 'success'
      run: |
        echo "ğŸ‰ DÃ‰PLOIEMENT SÃ‰CURISÃ‰ RÃ‰USSI !"
        echo ""
        echo "ğŸŒ L'application Acti'Vibe est maintenant accessible et sÃ©curisÃ©e :"
        echo "   â€¢ Frontend Nuxt.js : http://10.0.0.244:3000"
        echo "   â€¢ Backend Laravel API : http://10.0.0.244:8080"
        echo "   â€¢ phpMyAdmin : http://10.0.0.244:8082"
        echo "   â€¢ Neo4j : http://10.0.0.244:7474"
        echo ""
        echo "ğŸ³ Images dÃ©ployÃ©es avec corrections de sÃ©curitÃ© :"
        echo "   â€¢ Backend: ${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}"
        echo "   â€¢ Frontend: ${{ env.FRONTEND_IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}"
        echo ""
        echo "ğŸ”’ Corrections de sÃ©curitÃ© appliquÃ©es :"
        echo "   âœ… Authentification centralisÃ©e avec auth:sanctum"
        echo "   âœ… Middlewares de rÃ´les appropriÃ©s (admin, teacher, student)"
        echo "   âœ… Suppression de l'authentification manuelle"
        echo "   âœ… ContrÃ´leurs sÃ©curisÃ©s (AdminController, TeacherController, StudentController)"
        echo "   âœ… Routes sÃ©parÃ©es (routes/admin.php)"
        echo "   âœ… Message 'AccÃ¨s refusÃ©' corrigÃ©"
        echo ""
        echo "ğŸ“… Date : $(date)"

    - name: ğŸš¨ Notification d'Ã©chec
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ Ã‰CHEC DU DÃ‰PLOIEMENT SÃ‰CURISÃ‰ !"
        echo ""
        echo "ğŸ” VÃ©rifiez les logs ci-dessus pour identifier le problÃ¨me."
        echo "ğŸ“‹ Points Ã  vÃ©rifier :"
        echo "   â€¢ Connexion SSH au serveur"
        echo "   â€¢ Variables d'environnement GitHub"
        echo "   â€¢ DisponibilitÃ© de DockerHub"
        echo "   â€¢ Ã‰tat du serveur de production"
        echo "   â€¢ Corrections de sÃ©curitÃ© dans le code"
        echo ""
        echo "ğŸ†˜ En cas de problÃ¨me persistant, connectez-vous manuellement :"
        echo "   ssh ${{ vars.SERVER_USERNAME }}@${{ vars.SERVER_HOST }}"
        echo "   cd /srv/activibe && ./auto-deploy-secure.sh"

    - name: ğŸ“Š RÃ©sumÃ© du build sÃ©curisÃ©
      if: needs.build-images.result == 'success'
      run: |
        echo "âœ… BUILD SÃ‰CURISÃ‰ RÃ‰USSI !"
        echo ""
        echo "ğŸ—ï¸ Images construites avec corrections de sÃ©curitÃ© :"
        echo "   â€¢ Backend: ${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}"
        echo "   â€¢ Frontend: ${{ env.FRONTEND_IMAGE_NAME }}:${{ needs.prepare.outputs.image_tag }}"
        echo ""
        echo "ğŸ”’ Corrections de sÃ©curitÃ© intÃ©grÃ©es :"
        echo "   âœ… Authentification centralisÃ©e"
        echo "   âœ… Middlewares appropriÃ©s"
        echo "   âœ… ContrÃ´leurs sÃ©curisÃ©s"
        echo "   âœ… Suppression de l'authentification manuelle"
        echo ""
        echo "ğŸ“… Date : $(date)"
